#!/bin/bash

#:set ts=4 sw=4

SLEEPSECS=4
BINDIR=/usr/local/bin
LOGFILE='/home/pi/.dogsitter/logs/dogsitter.log'
PRIORITY=0
MACHINE=`hostname`
PYTHON='/usr/bin/python3.7'

CFG="/etc/dogsitter/dogsitter.cfg"
EXECUTABLE="/usr/local/bin/realtime_common_object_detection.py"

ip=$(awk -F= '/^ip=/{print $2}' ${CFG})
fps=$(awk -F= '/^fps=/{print $2}' ${CFG})
email=$(awk -F= '/^email=/{print $2}' ${CFG})
verbose=$(awk -F= '/^verbose=/{print $2}' ${CFG})
logfile=$(awk -F= '/^logfile=/{print $2}' ${CFG})
password=$(awk -F= '/^password=/{print $2}' ${CFG})
email_port=$(awk -F= '/^email_port=/{print $2}' ${CFG})
server_port=$(awk -F= '/^server_port=/{print $2}' ${CFG})
filter_pets=$(awk -F= '/^filter_pets=/{print $2}' ${CFG})
cam_location=$(awk -F= '/^cam_location=/{print $2}' ${CFG})
camview_port=$(awk -F= '/^camview_port=/{print $2}' ${CFG})
disable_email=$(awk -F= '/^disable_email=/{print $2}' ${CFG})
burst_mode_opts=$(awk -F= '/^burst_mode_opts=/{print $2}' ${CFG})
delta_thresh_max=$(awk -F= '/^delta_thresh_max=/{print $2}' ${CFG})
delta_thresh_min=$(awk -F= '/^delta_thresh_min=/{print $2}' ${CFG})
motion_thresh_min=$(awk -F= '/^motion_thresh_min=/{print $2}' ${CFG})

command="-e${email} -p${password} -c${cam_location} -b${burst_mode_opts} -f${fps} -l${logfile}"
command="${command} -E${email_port} -T${delta_thresh_max} -t${delta_thresh_min} -m${motion_thresh_min}"

if [[ $verbose == 'True' ]] ; then
    command="$command --verbose";
fi
if [[ $disable_email == 'True' ]] ; then
    command="$command --disable-email";
fi

echo "${command}" > $LOGFILE ;

message() {
    echo "$1" >&2 ;
    if [[ -n "$SYSLOG" ]] ; then
        logger -p "${SYSLOG}.warn" -t realtime_common_object_detection.py[$$] "$1" ;
    fi
    if [[ -n "$LOGFILE" ]] ; then
        echo "realtime_common_object_detection.py[$$]: $1" >> "$LOGFILE" ;
    fi
}

run_realtime_common_object_detectiond() {
    while true ; do
        cd $BINDIR ;
	$PYTHON $EXECUTABLE $command;
        EXITSTATUS=$? ;
        message "realtime_common_object_detection.py ended with exit status $EXITSTATUS" ;
        if [[ "${EXITSTATUS}" = "0" ]] ; then
            # Properly shutdown....
            message "realtime_common_object_detection.py shutdown normally." ;
            exit 0 ;
        #else
            #if [[ -n "${email}" ]] ; then
            #    echo "realtime_common_object_detection.py on $MACHINE died with exit status $EXITSTATUS.  Might want to take a peek." | \
            #    sendmail -s "realtime_common_object_detection.py Died" $email | \
            #    message "Exited on signal $EXITSTATUS" ;
            #fi
        fi
        message "Automatically restarting realtime_common_object_detection.py." ;
        sleep $SLEEPSECS ;
    done
}

run_realtime_common_object_detectiond &
